<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Verify Location</title>
  <style>
    *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #0f0f0f; color: #eee;
      display: flex; align-items: center; justify-content: center;
      min-height: 100vh; padding: 24px;
    }
    .card {
      background: #1a1a1a; border: 1px solid #2a2a2a;
      border-radius: 16px; padding: 40px 32px;
      text-align: center; max-width: 380px; width: 100%;
    }
    .icon { font-size: 52px; margin-bottom: 16px; }
    h1 { font-size: 22px; font-weight: 700; margin-bottom: 8px; }
    .desc { color: #888; font-size: 14px; line-height: 1.6; margin-bottom: 28px; }
    .btn {
      width: 100%; padding: 15px 24px; border: none; border-radius: 10px;
      font-size: 16px; font-weight: 700; cursor: pointer; transition: all .2s;
      display: flex; align-items: center; justify-content: center; gap: 10px;
      background: #00e5ff; color: #000; margin-bottom: 10px;
    }
    .btn:disabled { opacity: .5; cursor: default; }
    #status {
      margin-top: 20px; padding: 12px 16px; border-radius: 8px;
      font-size: 13px; line-height: 1.6; display: none;
    }
    #status.info { background: #1e2a2a; color: #00e5ff; display: block; }
    #status.ok   { background: #1a2e1a; color: #00c853; display: block; }
    #status.err  { background: #2e1a1a; color: #ff5555; display: block; }
    .steps { text-align: left; margin-top: 20px; display: none; }
    .step { font-size: 13px; color: #666; margin-bottom: 8px; }
    .step.done   { color: #00c853; }
    .step.active { color: #00e5ff; }
    .step.failed { color: #ff5555; }
  </style>
</head>
<body>
<div class="card">
  <div class="icon">üìç</div>
  <h1>Location Verification</h1>
  <p class="desc">Tap the button and allow location access when prompted.</p>
  <button class="btn" id="mainBtn" onclick="startTracking()">üìç Verify My Location</button>
  <div id="status"></div>
  <div class="steps" id="steps">
    <div class="step" id="s1">‚è≥ Requesting permission...</div>
    <div class="step" id="s2">‚è≥ Getting coordinates...</div>
    <div class="step" id="s3">‚è≥ Resolving address...</div>
    <div class="step" id="s4">‚è≥ Saving...</div>
  </div>
</div>

<script>
  var saved = false;

  function step(n, state, text) {
    var el = document.getElementById('s' + n);
    if (el) { el.className = 'step ' + state; if (text) el.textContent = text; }
    document.getElementById('steps').style.display = 'block';
  }

  function setStatus(msg, type) {
    var el = document.getElementById('status');
    el.className = type; el.textContent = msg;
  }

  async function geocode(lat, lon) {
    try {
      var r = await fetch(
        'https://nominatim.openstreetmap.org/reverse?lat=' + lat +
        '&lon=' + lon + '&format=json&addressdetails=1',
        { headers: { 'Accept-Language': 'en' } }
      );
      var d = await r.json();
      if (!d || !d.address) return null;
      var a = d.address;
      return {
        city:        a.city || a.town || a.village || a.suburb || a.county || '',
        region:      a.state || '',
        country:     a.country || '',
        countryCode: (a.country_code || '').toUpperCase(),
        zip:         a.postcode || '',
        fullAddress: d.display_name || ''
      };
    } catch(e) { return null; }
  }

  async function save(data) {
    if (saved) return;
    saved = true;
    step(4, 'active', '‚è≥ Saving...');
    try {
      var r = await fetch('/api/update-location', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      var d = await r.json();
      step(4, d.success ? 'done' : 'failed', d.success ? '‚úÖ Saved!' : '‚ùå Save failed');
    } catch(e) {
      step(4, 'failed', '‚ùå ' + e.message);
    }
  }

  async function onPosition(pos) {
    var lat = pos.coords.latitude;
    var lon = pos.coords.longitude;
    var acc = Math.round(pos.coords.accuracy);

    step(1, 'done', '‚úÖ Permission granted');
    step(2, 'done', '‚úÖ ' + lat.toFixed(5) + ', ' + lon.toFixed(5) + ' (¬±' + acc + 'm)');
    step(3, 'active', '‚è≥ Resolving address...');

    var geo = await geocode(lat, lon);

    if (geo && geo.city) {
      step(3, 'done', '‚úÖ ' + geo.city + ', ' + geo.region + ', ' + geo.country);
      setStatus('üìç ' + geo.city + ', ' + geo.region + ', ' + geo.country, 'ok');
      document.getElementById('mainBtn').textContent = '‚úÖ Location Verified';
      await save({ lat, lon, city: geo.city, region: geo.region, country: geo.country,
        countryCode: geo.countryCode, zip: geo.zip, fullAddress: geo.fullAddress,
        lookupSource: 'gpsNominatim' });
    } else {
      step(3, 'failed', '‚ö†Ô∏è Address not resolved ‚Äî saving coordinates');
      await save({ lat, lon, lookupSource: 'gpsOnly' });
    }
  }

  function onError(err) {
    var msgs = {
      1: 'Tap the üîí lock icon in your browser ‚Üí Permissions ‚Üí Location ‚Üí Allow, then retry.',
      2: 'GPS signal unavailable. Make sure Location is ON in your phone settings.',
      3: 'Timed out. Tap Retry ‚Äî GPS sometimes needs a moment to warm up.'
    };
    step(1, 'failed', '‚ùå ' + ['','Permission denied','Position unavailable','Timed out'][err.code]);
    setStatus(msgs[err.code] || err.message, 'err');
    document.getElementById('mainBtn').disabled = false;
    document.getElementById('mainBtn').textContent = 'üîÑ Retry';
  }

  function startTracking() {
    if (!navigator.geolocation) {
      setStatus('GPS not supported by your browser.', 'err'); return;
    }
    saved = false;
    document.getElementById('mainBtn').disabled = true;
    document.getElementById('mainBtn').textContent = '‚è≥ Detecting...';
    step(1, 'active', '‚è≥ Requesting permission...');

    // FIRST: fast low-accuracy fix (uses WiFi/cell ‚Äî returns in <2s, no timeout)
    navigator.geolocation.getCurrentPosition(
      onPosition, 
      function(err) {
        // Low accuracy failed ‚Äî try high accuracy GPS (slower but more precise)
        step(1, 'active', '‚è≥ Trying GPS chip...');
        navigator.geolocation.getCurrentPosition(
          onPosition,
          onError,
          { enableHighAccuracy: true, timeout: 30000, maximumAge: 0 }
        );
      },
      // Low accuracy options ‚Äî very fast, uses WiFi/cell towers
      { enableHighAccuracy: false, timeout: 8000, maximumAge: 30000 }
    );
  }
</script>
</body>
</html>
